// Prisma schema for Lead Flow (Supabase Postgres)
// - Mirrors the data model discussed (manager/operator, leads, activities)
// - Integrates with Supabase Auth via auth.users (User model)
// - Uses @updatedAt for updated_at columns
// - Adds sensible indexes and referential actions
// NOTE: RLS policies & triggers are not expressible in Prisma; create them via SQL migrations if needed.

// -----------------------------
// GENERATOR & DATASOURCE
// -----------------------------

generator client {
  provider = "prisma-client-js"
  runtime  = "bun"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./erd/diagram.md"
  format   = "mermaid"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// -----------------------------
// ENUMS
// -----------------------------

enum UserRole {
  manager
  operator
}

enum LeadStatus {
  new_opportunity
  scheduled
  no_show
  pricingRequest
  offerNegotiation
  pending_documents
  offerSubmission
  dps_agreement
  invoicePayment
  disqualified
  opportunityLost
  operator_denied
  contract_finalized
}

enum ActivityType {
  note
  call
  whatsapp
  email
  status_change
}

// AgeRange foi alterado para String - formato livre: "36, 32, 13"

enum HealthPlan {
  NOVA_ADESAO       @map("Nova Ades\u00e3o")
  AMIL              @map("Amil")
  BRADESCO          @map("Bradesco")
  HAPVIDA           @map("Hapvida")
  MEDSENIOR         @map("MedS\u00eanior")
  GNDI              @map("NotreDame Interm\u00e9dica (GNDI)")
  OMINT             @map("Omint")
  PLENA             @map("Plena")
  PORTO_SEGURO      @map("Porto Seguro")
  PREVENT_SENIOR    @map("Prevent Senior")
  SULAMERICA        @map("SulAm\u00e9rica")
  UNIMED            @map("Unimed")
  OUTROS            @map("Outros")
}

enum SubscriptionStatus {
  trial // Período de teste (7-30 dias)
  active // Ativa e paga
  past_due // Pagamento atrasado (ainda com acesso)
  suspended // Suspensa por falta de pagamento
  canceled // Cancelada pelo usuário

  @@map("subscription_status")
}

enum SubscriptionPlan {
  free_trial // Trial gratuito
  manager_base // R$ 59,90 - Somente Manager
  with_operators // R$ 59,90 + (N × R$ 19,90)

  @@map("subscription_plan")
}

// -----------------------------
// PROFILES (public.profiles)
// - Primary key is also a FK to auth.users.id (1:1)
// - Self-relation: operator -> manager
// -----------------------------

model Profile {
  id                    String              @id @unique @default(uuid()) @db.Uuid
  email                 String              @unique @db.Text
  supabaseId            String?             @unique @db.Uuid
  fullName              String?             @db.Text
  phone                 String?             @db.Text
  cpfCnpj               String?             @db.Text
  postalCode            String?             @db.Text
  address               String?             @db.Text
  addressNumber         String?             @db.Text
  complement            String?             @db.Text
  city                  String?             @db.Text
  state                 String?             @db.Text
  profileIconId         String?             @db.Text
  profileIconUrl        String?             @db.Text
  role                  UserRole            @default(manager)
  managerId             String?             @db.Uuid
  asaasCustomerId       String?             @db.Text
  subscriptionId        String?             @db.Text
  subscriptionStatus    SubscriptionStatus?
  subscriptionPlan      SubscriptionPlan?
  operatorCount         Int                 @default(0)
  subscriptionStartDate DateTime?           @db.Timestamptz(6)
  subscriptionEndDate   DateTime?           @db.Timestamptz(6)
  trialEndDate          DateTime?           @db.Timestamptz(6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  manager   Profile?  @relation("ManagerOperators", fields: [managerId], references: [id], onDelete: Restrict)
  operators Profile[] @relation("ManagerOperators")

  // Lead relations
  leadsAsManager  Lead[]           @relation("LeadManager")
  leadsAsAssignee Lead[]           @relation("LeadAssignee")
  leadsAsCreator  Lead[]           @relation("LeadCreator")
  leadsAsUpdater  Lead[]           @relation("LeadUpdater")
  activities      LeadActivity[]
  attachments     LeadAttachment[] @relation("AttachmentUploader")

  @@index([role])
  @@index([managerId])
  @@index([cpfCnpj])
  @@map("profiles")
}

// -----------------------------
// LEADS (public.leads)
// - tenant fence by managerId (uuid of manager profile)
// - assignedTo must be operator (validate at app layer or with DB trigger via SQL)
// -----------------------------

model Lead {
  id                String     @id @unique @default(uuid()) @db.Uuid
  managerId         String     @db.Uuid
  assignedTo        String?    @db.Uuid
  status            LeadStatus @default(new_opportunity)
  name              String     @db.Text
  email             String?    @db.Text
  phone             String?    @db.Text
  cnpj              String?             @db.Text
  age               String?             @db.Text
  currentHealthPlan HealthPlan?
  currentValue      Decimal?   @db.Decimal(12, 2)
  referenceHospital String?    @db.Text
  currentTreatment  String?    @db.Text
  meetingDate       DateTime?  @db.Timestamptz(6)
  notes             String?    @db.Text
  createdBy         String?    @db.Uuid
  updatedBy         String?    @db.Uuid
  createdAt         DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime   @updatedAt @db.Timestamptz(6)

  // Relations
  manager       Profile         @relation("LeadManager", fields: [managerId], references: [id], onDelete: Cascade)
  assignee      Profile?        @relation("LeadAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator       Profile?        @relation("LeadCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater       Profile?        @relation("LeadUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  activities    LeadActivity[]
  LeadsSchedule LeadsSchedule[]
  LeadFinalized LeadFinalized[]
  attachments   LeadAttachment[]

  // Unique per tenant
  @@unique([managerId, email])
  @@unique([managerId, phone])
  @@unique([managerId, cnpj])
  @@index([managerId])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([updatedBy])
  @@index([meetingDate])
  @@map("leads")
}

// -----------------------------
// LEAD ACTIVITIES (public.lead_activities)
// -----------------------------

model LeadActivity {
  id        String       @id @default(uuid()) @db.Uuid
  leadId    String       @db.Uuid
  type      ActivityType
  body      String?      @db.Text
  payload   Json?
  createdBy String?      @db.Uuid
  createdAt DateTime     @default(now()) @db.Timestamptz(6)

  lead   Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  author Profile? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([createdBy])
  @@map("lead_activities")
}

model LeadsSchedule {
  id        String   @id @default(uuid()) @db.Uuid
  leadId    String   @db.Uuid
  date      DateTime @db.Timestamptz(6)
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("leads_schedule")
}

model LeadFinalized {
  id              String   @id @default(uuid()) @db.Uuid
  leadId          String   @db.Uuid
  finalizedDateAt DateTime @db.Timestamptz(6)
  startDateAt     DateTime @db.Timestamptz(6)
  duration        Int // duration in days from lead creation to finalization
  amount          Decimal  @db.Decimal(12, 2)
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_finalized")
}

// -----------------------------
// LEAD ATTACHMENTS (public.lead_attachments)
// -----------------------------

model LeadAttachment {
  id          String   @id @default(uuid()) @db.Uuid
  leadId      String   @db.Uuid
  fileName    String   @db.Text
  fileUrl     String   @db.Text
  fileType    String   @db.Text // mime type: application/pdf, image/png, etc
  fileSize    Int // size in bytes
  uploadedBy  String   @db.Uuid
  uploadedAt  DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  lead     Lead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  uploader Profile @relation("AttachmentUploader", fields: [uploadedBy], references: [id], onDelete: Restrict)

  @@index([leadId])
  @@index([uploadedBy])
  @@map("lead_attachments")
}
